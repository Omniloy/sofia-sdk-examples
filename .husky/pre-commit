#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit security checks..."

# 1. Run security scan with Trivy (if available)
echo "ğŸ“Š Checking for vulnerabilities..."
if command -v trivy >/dev/null 2>&1; then
    echo "ğŸ” Running Trivy security scan..."
    if ! trivy fs . --format table --severity HIGH,CRITICAL --quiet; then
        echo "âŒ High or critical vulnerabilities detected!"
        echo "ğŸ’¡ Run 'npm run security:scan' for detailed report"
        exit 1
    fi
else
    echo "âš ï¸  Trivy not installed, skipping vulnerability scan"
    echo "ğŸ’¡ Install with: brew install trivy"
fi

# 2. Run secrets scan with GitLeaks (if available)  
echo "ğŸ” Checking for secrets..."
if command -v gitleaks >/dev/null 2>&1; then
    echo "ğŸ” Running GitLeaks secrets scan..."
    if ! gitleaks detect --source . --config .gitleaks.toml --no-banner; then
        echo "âŒ Potential secrets detected!"
        echo "ğŸ’¡ Run 'npm run secrets:check' for detailed report"
        exit 1
    fi
else
    echo "âš ï¸  GitLeaks not installed, please install for better security"
    echo "ğŸ’¡ Install with: brew install gitleaks"
fi


echo "âœ… Pre-commit security checks passed!"